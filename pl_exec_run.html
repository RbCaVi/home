<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>a</title>
		<script type="text/javascript" src="parsers.js"></script>
		<script type="text/javascript" src="expr.js"></script>
		<script type="text/javascript" src="stmt.js"></script>
		<script type="text/javascript" src="pl_parse.js"></script>
    <script type="text/javascript" src="pl_exec_run.js"></script>
  </head>
  <body>
    <p>upload a .plp file from parserlang here</p>
    <input type="file" id = "fileinput">
    <br>
    <p>try one of these</p>
    <button onclick="runp('print')">print empty string 5 times in a row</button>
    <!-- button onclick="runp('test')">syntax sampler</button -->
    <button onclick="runp('strcmp')">string equality</button>
    <button onclick="runp('str')">strings</button>
    <!-- button onclick="runp('parsers1')">idk parsers or something</button -->
    <!-- button onclick="runp('fib')">fibonaci</button -->
    <button onclick="runp('each2')">implicit generator showcase</button>
    <!-- button onclick="runp('each')">uhhh....</button -->
    <button onclick="runp('builtin')">we do a little builtins</button>
    <button onclick="runp('bind')">the bind builtin</button>
    <br>

		<div class = "column-container">
			<div class = "column">
				<p>or write source code here</p>
				<textarea id="source" rows="30"></textarea>
				<br>
				<button onclick="runs()">run</button>
			</div>
			<div class = "column">
				<p>Output</p>
				<textarea id="output" rows="30"></textarea>
			</div>
		</div>

    <script type="text/javascript">
      document.getElementById('source').value = ''; // clear browser cache
      document.getElementById('output').value = ''; // clear browser cache
      var print = function(text) {
				console.log(text);
				document.getElementById('output').value += text + "\n";
				document.getElementById('output').scrollTop = document.getElementById('output').scrollHeight;
			};
			
			document.getElementById('fileinput').addEventListener('change', async function(event) {
				const file = event.target.files[0];

				if (file) {
					const data = new Uint8Array(await file.arrayBuffer());
					document.getElementById('source').value = render(undump(data));
					run(data);
				}
			})

      async function runp(path) {
        document.getElementById('source').value = await (await fetch(path + '.pls')).text();
				const data = dump(prgm(document.getElementById('source').value));
        run(data);
      }

      async function runs(path) {
				const data = dump(prgm(document.getElementById('source').value));
        run(data);
      }

      async function run(data) {
				await promiseInitialized;
        document.getElementById('fileinput').value = ''; // clear
        document.getElementById('output').value = ''; // clear
        const stack = wasmExports.stackSave();
        const ret = wasmExports.stackAlloc(data.length);
        HEAP8.set(data, ret);
        wasmExports.run(ret);
        wasmExports.stackRestore(stack);
      }
    </script>
  </body>
</html>

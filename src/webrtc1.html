###script###js/element.js###/script###
###script###js/hash.js###/script###
###script###js/db.js###/script###
###script###js/auth.js###/script###
###script###js/account.js###/script###
###script###js/connect.js###/script###

###pagetitle###
webrtc server
###/pagetitle###

###title###
webrtc server
###/title###

###content###
<input type = 'text' id = 'username'>
<input type = 'text' id = 'password'>
<button id = 'login'>login</button>
<button id = 'sendoffer'>send offer</button>
<p id = 'oid'></p>
<button id = 'open'>open connection</button>
<button id = 'checknegotiations'>check for negotiation</button>
<div id = 'negotiations'></div>
<button id = 'sendlocaldesc'>send local description</button>
<button id = 'checkremotedesc'>check for remote description</button>
<div id = 'remotedescs'></div>
<button id = 'sendlocalice'>send local ICE candidates</button>
<button id = 'checkremoteice'>check for remote ICE candidates</button>
<div id = 'remoteices'></div>
<button id = 'connect'>connect</button>
<p id = 'status'></p>
###/content###

###pagescript###
function log(message) {
	console.log(message);
	document.querySelector('#status').append(message);
	document.querySelector('#status').append(element('br'));
}

let user;
document.querySelector('#login').addEventListener('click', async () => {
	user = await account.login(
		document.querySelector('#username').value,
		document.querySelector('#password').value
	);
	log('' + user.id + ' ' + user.token);
});
###/pagescript###

###pagescript###
// ts is from mozilla <3

let offer;
document.querySelector('#sendoffer').addEventListener('click', async () => {
	offer = await user.createoffer('test');
	document.querySelector('#oid').textContent = offer.id;
	log('created ' + offer.id + ' ' + JSON.stringify(offer.info));
});

function handleSendChannelStatusChange(event) {
  if (channel) {
    var state = channel.readyState;
  	
    console.log('state', state);
  }
}

function handleAddCandidateError(e) {
  console.log("Oh noes! addICECandidate failed!", e);
}

let connection;
let channel;
let icecandidates;
document.querySelector('#open').addEventListener('click', async () => {
	const response = await fetch("https://rbcavi.metered.live/api/v1/turn/credentials?apiKey=b74a9b6e9a63998537fa2265c6c9c560aaa5");

	// Saving the response in the iceServers array
	const iceServers = await response.json();
  /*const iceServers = [
	  {urls: ["stun:stun.l.google.com:19302"]},
    {
      urls: ['turn:openrelay.metered.ca:80'],
      username: 'openrelayproject',
      credentials: 'openrelayproject'
    },
	];*/

	connection = new RTCPeerConnection({
		iceServers
	});

	connection.onconnectionstatechange = () => log('state ' + connection.connectionState);
    
	connection.onicecandidate = e => !e.candidate || [icecandidates.push(e.candidate), log('ice ' + JSON.stringify(e.candidate))];

	channel = connection.createDataChannel("channel");
	channel.onopen = handleSendChannelStatusChange;
	channel.onclose = handleSendChannelStatusChange;

	icecandidates = [];
});

let negotiation;
document.querySelector('#checknegotiations').addEventListener('click', async () => {
	for (let onegotiation of await offer.getnegotiations()) {
		log('' + onegotiation.id + ' ' + onegotiation.username + ' ' + JSON.stringify(onegotiation.info));
		document.querySelector('#negotiations').append(element('div', {},
			element('button', {events: {click: async () => {
				negotiation = onegotiation;
				log('chose negotiation ' + onegotiation.id);
			}}}, 'choose'),
			onegotiation.id,
			' ',
			onegotiation.initiator,
			' ',
			onegotiation.responder,
			' ',
			JSON.stringify(onegotiation.info),
		))
	}
});

document.querySelector('#sendlocaldesc').addEventListener('click', async () => {
	let localdesc = await connection.createOffer();
	await connection.setLocalDescription(localdesc);
	await negotiation.sendinitiatordescription(localdesc);
	log('send desc ' + JSON.stringify(connection.localDescription));
});

document.querySelector('#checkremotedesc').addEventListener('click', async () => {
	let remotedescs = await negotiation.getresponderdescriptions();
	for (let remotedesc of remotedescs) {
		document.querySelector('#remotedescs').append(element('div', {},
			element('button', {events: {click: async () => {
				await connection.setRemoteDescription(remotedesc);
			}}}, 'add'),
			JSON.stringify(remotedesc),
		));
		log('recv desc ' + JSON.stringify(remotedesc));
	}
});

document.querySelector('#sendlocalice').addEventListener('click', async () => {
	for (let localice of icecandidates) {
		await negotiation.sendinitiatorice(localice);
		log('send ice ' + JSON.stringify(localice));
	}
});

document.querySelector('#checkremoteice').addEventListener('click', async () => {
	let remoteices = await negotiation.getresponderices();
	for (let remoteice of remoteices) {
		document.querySelector('#remoteices').append(element('div', {},
			element('button', {events: {click: async () => {
				await connection.addIceCandidate(remoteice);
			}}}, 'add'),
			JSON.stringify(remoteice),
		));
		log('recv ice ' + JSON.stringify(remoteice));
	}
});
###/pagescript###
